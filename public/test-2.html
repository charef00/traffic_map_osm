<!DOCTYPE html>
<html>
<head>
    <title>Interactive Map Routes</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { display: flex; }
        #map { height: 100vh; width: 80%; }
        #sidebar { height: 100vh; width: 20%; overflow-y: auto; background-color: #f0f0f0; padding: 20px; }
        .route-item { margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .route-item button { cursor: pointer; }
    </style>
</head>
<body>
<div id="map"></div>
<div id="sidebar"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([31.6295, -7.9811], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    var lastClickedLayer;
    var routeLayers = {};

    function onEachFeature(feature, layer) {
        if (feature.geometry.type === 'LineString' && feature.properties && feature.properties.id) {
            layer.bindPopup('Route ID: ' + feature.properties.id);

            layer.on('click', function() {
                highlightRoute(feature.properties.id, true);
            });

            // Store reference to each route layer by its ID
            routeLayers[feature.properties.id] = layer;
        }
    }

    function loadGeoJson() {
        fetch('/geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: function(feature) {
                        return feature.geometry.type === 'LineString' ? {color: 'black'} : {color: '#3388ff'};
                    },
                    onEachFeature: onEachFeature,
                    pointToLayer: function (feature, latlng) {
                        return L.featureGroup();
                    } 
                }).addTo(map);
            })
            .catch(err => console.error('Error loading the GeoJSON data:', err));
    }

    function addToSidebar(id, deferDisplay = false) {
        const sidebar = document.getElementById('sidebar');
        if (!document.getElementById('route-item-' + id)) {
            const item = document.createElement('div');
            item.id = 'route-item-' + id;
            item.className = 'route-item';
            item.innerHTML = `<span>Route ID: ${id}</span>`;
            if (!deferDisplay) {
                item.style.display = "flex";
            } else {
                // Defer display
                item.style.display = "none";
                setTimeout(() => { item.style.display = "flex"; }, 100); // Adjust delay as needed
            }
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'x';
            deleteButton.onclick = function(event) {
                event.stopPropagation(); // Prevent triggering the click event of the parent div
                sidebar.removeChild(item);
                if (lastClickedLayer && lastClickedLayer.feature.properties.id === id) {
                    lastClickedLayer.setStyle({ color: 'black' });
                }
                if (routeLayers[id]) {
                    map.removeLayer(routeLayers[id]);
                }
            };
            item.appendChild(deleteButton);
            item.onclick = function() { highlightRoute(id); };
            sidebar.insertBefore(item, sidebar.firstChild); // Add new items to the top
        }
    }

    function highlightRoute(id, deferDisplay = false) {
        if (lastClickedLayer) {
            lastClickedLayer.setStyle({ color: 'black' });
        }
        var layer = routeLayers[id];
        if (layer) {
            layer.setStyle({ color: 'red' });
            layer.openPopup();
            lastClickedLayer = layer;
        }
        addToSidebar(id, deferDisplay); // Add to sidebar if not already present
    }

    loadGeoJson();
</script>
</body>
</html>
